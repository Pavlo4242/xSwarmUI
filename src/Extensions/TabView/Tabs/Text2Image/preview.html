<div class="preview-container-wrapper">
    
    <style>
        .preview-container-wrapper {
            height: calc(100vh - 80px) !important;
            width: 100% !important;
            display: flex !important;
            flex-direction: column !important;
            background: #1a1a1a !important;
            color: #eee !important;
            font-family: sans-serif;
            overflow: hidden !important;
        }

        /* HEADER */
        .p-header {
            height: 50px !important;
            min-height: 50px !important;
            background: #252525 !important;
            border-bottom: 1px solid #444 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            padding: 0 15px !important;
        }

        /* GRID */
        .preview-grid {
            display: flex !important;
            flex-direction: row !important;
            flex: 1 !important;
            height: 100% !important;
            width: 100% !important;
            overflow: hidden !important;
        }

        .p-col-left {
            width: 320px !important;
            min-width: 320px !important;
            background: #202020 !important;
            border-right: 1px solid #444 !important;
            padding: 15px !important;
            overflow-y: auto !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 10px !important;
        }

        .p-col-center {
            flex: 1 !important;
            background: #000 !important;
            display: flex !important;
            flex-direction: column !important;
            position: relative !important;
            overflow: hidden !important;
        }

        .p-col-right {
            width: 280px !important;
            min-width: 280px !important;
            background: #202020 !important;
            border-left: 1px solid #444 !important;
            padding: 15px !important;
            overflow-y: auto !important;
        }

        /* INPUTS */
        .p-input {
            background: #333 !important;
            border: 1px solid #555 !important;
            color: #eee !important;
            width: 100% !important;
            padding: 6px !important;
            border-radius: 4px !important;
            box-sizing: border-box !important;
            font-size: 13px !important;
        }
        .p-input:focus { border-color: #0d6efd !important; outline: none !important; }

        .p-btn {
            background: #444 !important;
            border: 1px solid #555 !important;
            color: #eee !important;
            padding: 5px 15px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
        }
        .p-btn:hover { background: #555 !important; }
        .p-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .p-btn-primary { background: #0d6efd !important; border-color: #0d6efd !important; font-weight: bold !important; }
        .p-btn-danger { background: #dc3545 !important; border-color: #dc3545 !important; }
        
        .p-label { font-size: 11px !important; font-weight: bold !important; color: #aaa !important; text-transform: uppercase !important; display: block !important; margin-bottom: 4px !important; }

        /* IMAGE AREA */
        .p-image-area {
            flex: 1 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            overflow: hidden !important;
            position: relative !important;
            background-image: linear-gradient(45deg, #222 25%, transparent 25%), linear-gradient(-45deg, #222 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #222 75%), linear-gradient(-45deg, transparent 75%, #222 75%);
            background-size: 20px 20px;
        }
        .p-image-area img { max-width: 100%; max-height: 100%; object-fit: contain; transition: opacity 0.2s; }
        .p-image-area img.generating { image-rendering: pixelated !important; }

        /* STEP STRIP (Middle) */
        .p-step-strip {
            height: 80px !important;
            background: #2a2a2a !important;
            border-top: 1px solid #444 !important;
            display: flex !important;
            gap: 5px !important;
            padding: 5px !important;
            overflow-x: auto !important;
            align-items: center !important;
        }
        .p-step-item {
            width: 70px !important;
            min-width: 70px !important;
            height: 70px !important;
            background: #000;
            border: 2px solid #555;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            position: relative;
        }
        .p-step-item:hover { opacity: 0.9; border-color: #888; }
        .p-step-item.active { opacity: 1; border-color: #0d6efd !important; }
        .p-step-item img { width: 100%; height: 100%; object-fit: cover; }
        .p-step-number {
            position: absolute;
            bottom: 2px;
            right: 4px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 2px;
        }

        .p-modify-mode-warning {
            background: #ff9900;
            color: #000;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }

        /* HISTORY STRIP (Bottom) */
        .p-history {
            height: 100px !important;
            background: #151515 !important;
            border-top: 1px solid #444 !important;
            display: flex !important;
            gap: 10px !important;
            padding: 10px !important;
            overflow-x: auto !important;
            align-items: center !important;
        }
        .p-history-item { 
            width: 80px !important; 
            min-width: 80px !important;
            height: 80px !important; 
            background: #000; 
            border: 2px solid transparent; 
            position: relative;
            cursor: pointer;
            border-radius: 4px;
            overflow: hidden;
        }
        .p-history-item img { width: 100%; height: 100%; object-fit: cover; }
        .p-history-item.active { border-color: #0d6efd !important; }
        
        /* History Item Overlay */
        .p-hist-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.8); display: flex; justify-content: space-around;
            padding: 2px 0; opacity: 0; transition: opacity 0.2s;
        }
        .p-history-item:hover .p-hist-overlay { opacity: 1; }
        .p-icon-btn { color: white; cursor: pointer; font-size: 10px; }
        .p-icon-btn:hover { color: #0d6efd; }

        /* OVERLAYS */
        .p-overlay-info { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            background: rgba(0,0,0,0.8); 
            padding: 5px 10px; 
            border-radius: 4px; 
            font-size: 11px; 
            display: none;
            color: #0d6efd;
        }
        .p-overlay-progress { 
            position: absolute; 
            bottom: 80px; 
            left: 0; 
            width: 100%; 
            height: 5px; 
            background: rgba(0,0,0,0.5); 
            display: none; 
        }
        .p-overlay-progress-fill { height: 100%; background: #0d6efd; width: 0%; transition: width 0.1s; }
        
        /* Connection Status */
        .p-connection-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }
        .p-connection-status.connected { background: #28a745; color: white; }
        .p-connection-status.connecting { background: #ffc107; color: black; }
        .p-connection-status.disconnected { background: #dc3545; color: white; }
        
        /* Debug Console */
        #p_debug { 
            height: 60px; 
            background: #111; 
            color: #0f0; 
            font-family: monospace; 
            font-size: 10px; 
            padding: 5px; 
            overflow-y: auto; 
            border-top: 1px solid #444; 
        }

        /* Step strip empty state */
        .p-step-strip-empty {
            margin: auto;
            color: #666;
            font-size: 11px;
            font-style: italic;
        }
    </style>

    <div class="p-header">
        <div style="font-size: 18px; font-weight: bold;">
            <i class="fas fa-eye" style="color:#0d6efd"></i> Live Preview
            <span id="p_connection_status" class="p-connection-status disconnected">Disconnected</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <label style="font-size:12px; cursor:pointer;">
                <input type="checkbox" id="p_auto" checked> Auto-Gen
            </label>
            <label style="font-size:12px; cursor:pointer;" title="Watch main tab generations">
                <input type="checkbox" id="p_watch_main" checked> Watch Main
            </label>
            <label style="font-size:12px; cursor:pointer;" title="Enable to modify parameters without auto-capturing">
                <input type="checkbox" id="p_modify_mode"> Modify Mode
                <span id="p_modify_warning" class="p-modify-mode-warning" style="display:none">MODIFYING</span>
            </label>
            <button id="p_pull" class="p-btn">Pull Params</button>
            <button id="p_push" class="p-btn">Push Params</button>
            <button id="p_gen" class="p-btn p-btn-primary">GENERATE</button>
            <button id="p_interrupt" class="p-btn p-btn-danger" style="display:none">STOP</button>
            <button id="p_clear_steps" class="p-btn" title="Clear step previews">Clear Steps</button>
            <button id="p_clear_history" class="p-btn" title="Clear generation history">Clear History</button>
        </div>
    </div>

    <div class="preview-grid">
        <div class="p-col-left">
            <div>
                <span class="p-label">Prompt</span>
                <textarea id="p_prompt" class="p-input" rows="6"></textarea>
            </div>
            <div>
                <textarea id="p_neg" class="p-input" rows="4" placeholder="Negative Prompt"></textarea>
            </div>
            <hr style="border:0; border-top:1px solid #444; width:100%;">
            
            <span class="p-label">Settings</span>
            <div>
                <label class="p-label" style="text-transform:none">Model</label>
                <select id="p_model" class="p-input"></select>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><span class="p-label">Steps</span><input type="number" id="p_steps" class="p-input" value="20"></div>
                <div style="flex:1"><span class="p-label">CFG</span><input type="number" id="p_cfg" class="p-input" value="7" step="0.5"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><span class="p-label">Width</span><input type="number" id="p_width" class="p-input" value="512" step="64"></div>
                <div style="flex:1"><span class="p-label">Height</span><input type="number" id="p_height" class="p-input" value="512" step="64"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><span class="p-label">Batch</span><input type="number" id="p_batch" class="p-input" value="1"></div>
                <div style="flex:1"><span class="p-label">Seed</span><input type="number" id="p_seed" class="p-input" value="-1"></div>
            </div>
        </div>

        <div class="p-col-center">
            <div class="p-image-area">
                <img id="p_img" src="imgs/model_placeholder.jpg">
                <div id="p_info" class="p-overlay-info">Step: 0/20</div>
                <div id="p_progress" class="p-overlay-progress">
                    <div id="p_fill" class="p-overlay-progress-fill"></div>
                </div>
                <div id="p_error" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:red; color:white; padding:15px; display:none; border-radius:4px; max-width:80%; text-align:center;"></div>
            </div>
            
            <div id="p_steps" class="p-step-strip">
                <div class="p-step-strip-empty">Preview steps will appear here during generation...</div>
            </div>

            <div id="p_history" class="p-history">
                <div style="margin:auto; color:#666; font-style:italic;">Generation history will appear here</div>
            </div>
            
            <div id="p_debug">Console Ready. Preview Tab v7 - Production WebSocket Handler</div>
        </div>

        <div class="p-col-right">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span class="p-label">ACTIVE LORAS</span>
                <button id="p_refresh_loras" style="background:none; border:none; color:#888; cursor:pointer;" title="Refresh LoRA list">&#x21bb;</button>
            </div>
            <div id="p_loras" style="display:flex; flex-direction:column; gap:8px;">
                <div style="color:#666; font-size:11px; text-align:center;">No LoRAs active</div>
            </div>
        </div>
    </div>

<script src="tab_view.js"></script>
</div>